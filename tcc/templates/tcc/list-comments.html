{% macro paginator(paginator) -%}
{% if paginator.pages > 1 %}
    {% macro _page(page, pk, text=None) -%}
        <a {% if paginator.page == page %}class="selected"{% endif %} href="{{ paginator.get_link(page, None) }}">{{ text|default(page)|safe }}</a>
    {% endmacro %}

<div class="pagination">
    <!--{% trans %}previous{% endtrans %}-->
    {% if paginator.previous %}{{ _page(paginator.previous[0], paginator.previous[1], '&laquo; ' + 'previous') }}{% endif %}

    {% if paginator.left %}
        {% for page, pk in paginator.left %}{{ _page(page, pk) }}{% endfor %}
        . . .
    {% endif %}

    {% for page, pk in paginator.middle %}{{ _page(page, pk) }}{% endfor %}

    {# Disabled to keep people from jumping to the end. Reduces load quite a lot
    {% if paginator.right %}
        . . .
        {% for page, pk in paginator.right %}{{ _page(page, pk) }}{% endfor %}
    {% endif %}
    #}

    <!--{% trans %}next{% endtrans %}-->
    {% if paginator.next %}{{ _page(paginator.next[0], paginator.next[1], 'next' + ' &raquo;') }}{% endif %}
</div>
{% endif %}
{%- endmacro %}

<ul id="tcc">
  {% if user.is_authenticated() %}
  <form action="{% url tcc_post %}" method="post">
    {% csrf_token %}
    {% for fld in form %}{{ fld.as_widget() }}{% endfor %}
    <div>
      <input type="submit" name="some_name" value="{% trans %}Save{% endtrans %}">
      <a style="display:none" class="reply-form" href="#" title="{% trans %}Cancel{% endtrans %}">{% trans %}Cancel{% endtrans %}</a>
    </div>
  </form>
  {% else %}
  <p>Please <a href="{% url auth_login %}">log in</a> to share your insights</p>
  {% endif %}

  {% set levels = [0] %}
  {% set prev = None %}

  {% if not comments %}
  <div class="blank_slate small" style="margin-top: 10px;">
    {% trans %}There's no gossip yet...{% endtrans %}
  </div>
  {% endif %}


  {% with comment_paginator = SmartQuerySetPaginator(comments, request.GET, 9, 'c') %}
  {% for c in comment_paginator.get_objects() %}

  {% if prev == None and c.parent %}
     {% continue %}
  {% endif %}

  {# administration #}
  {% set prevs = levels %}
  {% set lvl = c.depth %}
  {% if c.parent %}
    {% set childcount = childcount + 1 %}
    {% set levels = levels[:lvl] + [lvl] %}
  {% else %}
    {% set levels = [0] %}
    {% set childcount = 0 %}
  {% endif %}

  {# opening / closing of uls and li's #}
  {% if levels > prevs %}
    <ul class="replies">
  {% elif levels == prevs %}
  </li>
  {% else %}
    {% for x in prevs[lvl:-1] %}
    </ul>
    {% if prev.parent.childcount > c.REPLY_LIMIT %}<a class="showall" href="{% url tcc_replies prev.parent.id %}" title="{% trans %}Show all{% endtrans %}">
      {% trans %}Show all{% endtrans %}</a>{% endif %}
  </li>
    {% endfor %}
  {% endif %}

  {% set doclose = true %}
  {% include 'tcc/comment.html' %}

  {# close the last li (and / or uls) #}
  {% if loop.last %}
  {% if lvl ==  0 %}
    {% if c.childcount %}
    <a class="showall" href="{% url tcc_replies c.id %}" title="{% trans %}Show all{% endtrans %}">
      {% trans %}Show all{% endtrans %}</a>
    {% endif %}
  </li>
  {% else %}
  {% for _ in levels[1:] %}
    </ul>
    {% if childcount < c.parent.childcount or c.parent.childcount > c.REPLY_LIMIT %}
    <a class="showall" href="{% url tcc_replies c.parent.id %}" title="{% trans %}Show all{% endtrans %}">
      {% trans %}Show all{% endtrans %}</a>
    {% endif %}
  </li>
  {% endfor %}
  {% endif %}
  {% endif %}

  {% set prev = c %}

  {% endfor %}

  {{ paginator(comment_paginator) }}

  {% endwith %}

  <form class="remove-form" action="" method="post" style="display:none">
    {% csrf_token %}
    {% trans %}Are you sure you want to delete this comment?{% endtrans %}
    <input type="submit" name="remove-submit" value="{% trans %}Yes{% endtrans %}">
    <a class="remove-cancel" href="#">{% trans %}Cancel{% endtrans %}
  </form>
</ul>

<script type="text/javascript">
  $(document).ready(function(){
  {% if user.is_authenticated %}
  $(document).tcc({user_id: {{ user.id }}, user_name: '{{ user.username }}'});
  {% else %}
  $(document).tcc();
  {% endif %}
  });
</script>
